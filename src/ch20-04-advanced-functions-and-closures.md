## الدوال والإغلاقات المتقدمة (Advanced Functions and Closures)

يستكشف هذا القسم بعض الميزات المتقدمة المتعلقة بالدوال والإغلاقات، بما في ذلك مؤشرات الدوال وإرجاع الإغلاقات.

### مؤشرات الدوال

لقد تحدثنا عن كيفية تمرير الإغلاقات إلى الدوال؛ يمكنك أيضًا تمرير الدوال العادية إلى الدوال! هذه التقنية مفيدة عندما تريد تمرير دالة قمت بتعريفها بالفعل بدلاً من تعريف إغلاق جديد. يتم تحويل الدوال إلى النوع `fn` (بحرف _f_ صغير)، دون الخلط مع سِمَة الإغلاق `Fn`. يُسمى نوع `fn` _مؤشر دالة_ (function pointer). تمرير الدوال بمؤشرات الدوال سيسمح لك باستخدام الدوال كوسائط لدوال أخرى.

بناء الجملة لتحديد أن معامل هو مؤشر دالة مشابه لبناء جملة الإغلاقات، كما هو موضح في القائمة 20-28، حيث عرفنا دالة `add_one` التي تضيف 1 إلى معاملها. تأخذ الدالة `do_twice` معاملين: مؤشر دالة لأي دالة تأخذ معامل `i32` وتعيد `i32`، وقيمة `i32` واحدة. تستدعي الدالة `do_twice` الدالة `f` مرتين، تمرر لها قيمة `arg`، ثم تضيف نتائج استدعاء الدالتين معًا. تستدعي الدالة `main` الدالة `do_twice` بالوسائط `add_one` و `5`.

<Listing number="20-28" file-name="src/main.rs" caption="استخدام نوع `fn` لقبول مؤشر دالة كوسيطة">

```rust
{{#rustdoc_include ../listings/ch20-advanced-features/listing-20-28/src/main.rs}}
```

</Listing>

يطبع هذا الكود `The answer is: 12`. نحدد أن المعامل `f` في `do_twice` هو `fn` يأخذ معامل واحد من النوع `i32` ويعيد `i32`. يمكننا بعد ذلك استدعاء `f` في جسم `do_twice`. في `main`، يمكننا تمرير اسم الدالة `add_one` كوسيطة أولى لـ `do_twice`.

على عكس الإغلاقات، `fn` هو نوع بدلاً من سِمَة، لذلك نحدد `fn` كنوع المعامل مباشرة بدلاً من التصريح عن معامل نوع عمومي بإحدى سِمَات `Fn` كقيد سِمَة.

تطبق مؤشرات الدوال جميع سِمَات الإغلاق الثلاث (`Fn`، `FnMut`، و `FnOnce`)، مما يعني أنه يمكنك دائمًا تمرير مؤشر دالة كوسيطة لدالة تتوقع إغلاقًا. من الأفضل كتابة الدوال باستخدام نوع عمومي وإحدى سِمَات الإغلاق بحيث يمكن لدوالك قبول الدوال أو الإغلاقات.

ومع ذلك، مثال واحد على حالة تريد فيها قبول `fn` فقط وليس الإغلاقات هو عند التواصل مع كود خارجي لا يحتوي على إغلاقات: دوال C يمكنها قبول الدوال كوسائط، لكن C لا تحتوي على إغلاقات.

كمثال على حالة يمكنك فيها استخدام إما إغلاق معرف مضمّن أو دالة مسماة، دعنا ننظر إلى استخدام طريقة `map` التي توفرها سِمَة `Iterator` في المكتبة القياسية. لاستخدام طريقة `map` لتحويل متجه من الأرقام إلى متجه من السلاسل، يمكننا استخدام إغلاق، كما في القائمة 20-29.

<Listing number="20-29" caption="استخدام إغلاق مع طريقة `map` لتحويل الأرقام إلى سلاسل">

```rust
{{#rustdoc_include ../listings/ch20-advanced-features/listing-20-29/src/main.rs:here}}
```

</Listing>

أو يمكننا تسمية دالة كوسيطة لـ `map` بدلاً من الإغلاق. توضح القائمة 20-30 كيف سيبدو ذلك.

<Listing number="20-30" caption="استخدام دالة `String::to_string` مع طريقة `map` لتحويل الأرقام إلى سلاسل">

```rust
{{#rustdoc_include ../listings/ch20-advanced-features/listing-20-30/src/main.rs:here}}
```

</Listing>

لاحظ أنه يجب علينا استخدام بناء الجملة المؤهل بالكامل الذي تحدثنا عنه في قسم ["السِمَات المتقدمة"][advanced-traits]<!-- ignore --> لأن هناك دوال متعددة متاحة تُسمى `to_string`.

هنا، نستخدم دالة `to_string` المعرفة في سِمَة `ToString`، والتي طبقتها المكتبة القياسية لأي نوع يطبق `Display`.

تذكر من قسم ["قيم Enum"][enum-values]<!-- ignore --> في الفصل 6 أن اسم كل متغير enum نعرفه يصبح أيضًا دالة تهيئة. يمكننا استخدام دوال التهيئة هذه كمؤشرات دوال تطبق سِمَات الإغلاق، مما يعني أنه يمكننا تحديد دوال التهيئة كوسائط للطرق التي تأخذ إغلاقات، كما هو موضح في القائمة 20-31.

<Listing number="20-31" caption="استخدام مُهيئ enum مع طريقة `map` لإنشاء نسخة `Status` من الأرقام">

```rust
{{#rustdoc_include ../listings/ch20-advanced-features/listing-20-31/src/main.rs:here}}
```

</Listing>

هنا، ننشئ نسخ `Status::Value` باستخدام كل قيمة `u32` في النطاق الذي يتم استدعاء `map` عليه باستخدام دالة التهيئة لـ `Status::Value`. يفضل بعض الناس هذا الأسلوب وبعض الناس يفضلون استخدام الإغلاقات. إنها تُترجم إلى نفس الكود، لذلك استخدم أي أسلوب أوضح لك.

### إرجاع الإغلاقات

يتم تمثيل الإغلاقات بالسِمَات، مما يعني أنك لا تستطيع إرجاع الإغلاقات مباشرة. في معظم الحالات التي قد ترغب فيها في إرجاع سِمَة، يمكنك بدلاً من ذلك استخدام النوع الملموس الذي يطبق السِمَة كقيمة إرجاع للدالة. ومع ذلك، لا يمكنك عادةً فعل ذلك مع الإغلاقات لأنها لا تحتوي على نوع ملموس قابل للإرجاع؛ لا يُسمح لك باستخدام مؤشر الدالة `fn` كنوع إرجاع إذا كان الإغلاق يلتقط أي قيم من نطاقه، على سبيل المثال.

بدلاً من ذلك، ستستخدم عادةً بناء جملة `impl Trait` الذي تعلمناه في الفصل 10. يمكنك إرجاع أي نوع دالة، باستخدام `Fn`، `FnOnce`، و `FnMut`. على سبيل المثال، سيتم ترجمة الكود في القائمة 20-32 بشكل جيد.

<Listing number="20-32" caption="إرجاع إغلاق من دالة باستخدام بناء جملة `impl Trait`">

```rust
{{#rustdoc_include ../listings/ch20-advanced-features/listing-20-32/src/lib.rs}}
```

</Listing>

ومع ذلك، كما لاحظنا في قسم ["استنتاج وتعليق أنواع الإغلاق"][closure-types]<!-- ignore --> في الفصل 13، كل إغلاق هو أيضًا نوعه المميز الخاص. إذا كنت بحاجة إلى العمل مع دوال متعددة لها نفس التوقيع ولكن تطبيقات مختلفة، ستحتاج إلى استخدام كائن سِمَة لها. ضع في اعتبارك ما يحدث إذا كتبت كودًا مثل ذلك الموضح في القائمة 20-33.

<Listing file-name="src/main.rs" number="20-33" caption="إنشاء `Vec<T>` من الإغلاقات المعرفة بواسطة دوال تعيد أنواع `impl Fn`">

```rust,ignore,does_not_compile
{{#rustdoc_include ../listings/ch20-advanced-features/listing-20-33/src/main.rs}}
```

</Listing>

لدينا هنا دالتان، `returns_closure` و `returns_initialized_closure`، وكلاهما يعيد `impl Fn(i32) -> i32`. لاحظ أن الإغلاقات التي تعيدها مختلفة، على الرغم من أنها تطبق نفس النوع. إذا حاولنا ترجمة هذا، سيخبرنا Rust أنه لن يعمل:

```text
{{#include ../listings/ch20-advanced-features/listing-20-33/output.txt}}
```

تخبرنا رسالة الخطأ أنه كلما أعدنا `impl Trait`، ينشئ Rust _نوعًا معتمًا_ (opaque type) فريدًا، وهو نوع لا يمكننا رؤية تفاصيل ما ينشئه Rust لنا، ولا يمكننا تخمين النوع الذي سينشئه Rust لنكتبه بأنفسنا. لذلك، على الرغم من أن هذه الدوال تعيد إغلاقات تطبق نفس السِمَة، `Fn(i32) -> i32`، فإن الأنواع المعتمة التي ينشئها Rust لكل منها مميزة. (هذا مشابه لكيفية إنتاج Rust أنواعًا ملموسة مختلفة لكتل async مميزة حتى عندما يكون لها نفس نوع الإخراج، كما رأينا في ["نوع `Pin` وسِمَة `Unpin`"][future-types]<!-- ignore --> في الفصل 17.) لقد رأينا حلاً لهذه المشكلة عدة مرات الآن: يمكننا استخدام كائن سِمَة، كما في القائمة 20-34.

<Listing number="20-34" caption="إنشاء `Vec<T>` من الإغلاقات المعرفة بواسطة دوال تعيد `Box<dyn Fn>` بحيث يكون لها نفس النوع">

```rust
{{#rustdoc_include ../listings/ch20-advanced-features/listing-20-34/src/main.rs:here}}
```

</Listing>

سيتم ترجمة هذا الكود بشكل جيد. لمزيد من المعلومات حول كائنات السِمَات، راجع قسم ["استخدام كائنات السِمَات للتجريد فوق السلوك المشترك"][trait-objects]<!-- ignore --> في الفصل 18.

بعد ذلك، دعنا ننظر إلى الماكرو!

[advanced-traits]: ch20-02-advanced-traits.html#advanced-traits
[enum-values]: ch06-01-defining-an-enum.html#enum-values
[closure-types]: ch13-01-closures.html#closure-type-inference-and-annotation
[future-types]: ch17-03-more-futures.html
[trait-objects]: ch18-02-trait-objects.html
