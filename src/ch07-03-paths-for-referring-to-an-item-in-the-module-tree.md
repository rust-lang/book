## المسارات للإشارة إلى عنصر في شجرة الوحدات

لإظهار Rust مكان العثور على عنصر في شجرة الوحدات، نستخدم مسارًا بنفس الطريقة التي نستخدم بها المسار عند التنقل في نظام الملفات. لاستدعاء دالة، نحتاج إلى معرفة مسارها.

يمكن أن يأخذ المسار شكلين:

- _المسار المطلق_ هو المسار الكامل الذي يبدأ من جذر الصندوق؛ بالنسبة للكود من صندوق خارجي، يبدأ المسار المطلق باسم الصندوق، وبالنسبة للكود من الصندوق الحالي، يبدأ بالكلمة الحرفية `crate`.
- _المسار النسبي_ يبدأ من الوحدة الحالية ويستخدم `self` أو `super` أو معرّف في الوحدة الحالية.

كل من المسارات المطلقة والنسبية يُتبع بمعرّف واحد أو أكثر مفصولين بنقطتين مزدوجتين (`::`).

بالعودة إلى القائمة 7-1، لنفترض أننا نريد استدعاء دالة `add_to_waitlist`. هذا يعادل السؤال: ما هو مسار دالة `add_to_waitlist`؟ تحتوي القائمة 7-3 على القائمة 7-1 مع إزالة بعض الوحدات والدوال.

سنعرض طريقتين لاستدعاء دالة `add_to_waitlist` من دالة جديدة `eat_at_restaurant`، محددة في جذر الصندوق. هذه المسارات صحيحة، لكن هناك مشكلة أخرى متبقية ستمنع هذا المثال من الترجمة كما هو. سنشرح السبب بعد قليل.

دالة `eat_at_restaurant` هي جزء من واجهة برمجة التطبيقات العامة لصندوق المكتبة الخاص بنا، لذا نضع عليها الكلمة المفتاحية `pub`. في قسم [كشف المسارات باستخدام الكلمة المفتاحية `pub`][pub]<!-- ignore -->، سنتعمق أكثر في تفاصيل `pub`.

<Listing number="7-3" file-name="src/lib.rs" caption="استدعاء دالة `add_to_waitlist` باستخدام المسارات المطلقة والنسبية">

```rust,ignore,does_not_compile
{{#rustdoc_include ../listings/ch07-managing-growing-projects/listing-07-03/src/lib.rs}}
```

</Listing>

في المرة الأولى التي نستدعي فيها دالة `add_to_waitlist` في `eat_at_restaurant`، نستخدم مسارًا مطلقًا. دالة `add_to_waitlist` معرّفة في نفس الصندوق الذي يحتوي على `eat_at_restaurant`، مما يعني أنه يمكننا استخدام الكلمة المفتاحية `crate` لبدء مسار مطلق. نقوم بعد ذلك بتضمين كل وحدة من الوحدات المتعاقبة حتى نصل إلى `add_to_waitlist`. يمكنك تخيل نظام ملفات بنفس البنية: سنحدد المسار `/front_of_house/hosting/add_to_waitlist` لتشغيل برنامج `add_to_waitlist`؛ استخدام اسم `crate` للبدء من جذر الصندوق يشبه استخدام `/` للبدء من جذر نظام الملفات في shell الخاص بك.

في المرة الثانية التي نستدعي فيها `add_to_waitlist` في `eat_at_restaurant`، نستخدم مسارًا نسبيًا. يبدأ المسار بـ `front_of_house`، اسم الوحدة المعرّفة على نفس المستوى من شجرة الوحدات مثل `eat_at_restaurant`. هنا يكون المعادل في نظام الملفات استخدام المسار `front_of_house/hosting/add_to_waitlist`. البدء باسم وحدة يعني أن المسار نسبي.

اختيار ما إذا كنت تريد استخدام مسار نسبي أو مطلق هو قرار ستتخذه بناءً على مشروعك، ويعتمد على ما إذا كنت أكثر عرضة لنقل كود تعريف العنصر بشكل منفصل عن أو مع الكود الذي يستخدم العنصر. على سبيل المثال، إذا نقلنا وحدة `front_of_house` ودالة `eat_at_restaurant` إلى وحدة باسم `customer_experience`، سنحتاج إلى تحديث المسار المطلق إلى `add_to_waitlist`، لكن المسار النسبي سيظل صالحًا. ومع ذلك، إذا نقلنا دالة `eat_at_restaurant` بشكل منفصل إلى وحدة باسم `dining`، فسيبقى المسار المطلق إلى استدعاء `add_to_waitlist` كما هو، لكن المسار النسبي سيحتاج إلى التحديث. تفضيلنا بشكل عام هو تحديد المسارات المطلقة لأنه من المرجح أن نرغب في نقل تعريفات الكود واستدعاءات العناصر بشكل مستقل عن بعضها البعض.

لنحاول ترجمة القائمة 7-3 ونكتشف لماذا لن تُترجم بعد! الأخطاء التي نحصل عليها موضحة في القائمة 7-4.

<Listing number="7-4" caption="أخطاء المُترجم من بناء الكود في القائمة 7-3">

```console
{{#include ../listings/ch07-managing-growing-projects/listing-07-03/output.txt}}
```

</Listing>

تقول رسائل الخطأ أن وحدة `hosting` خاصة. بمعنى آخر، لدينا المسارات الصحيحة لوحدة `hosting` ودالة `add_to_waitlist`، لكن Rust لن يسمح لنا باستخدامها لأنه ليس لديه وصول إلى الأقسام الخاصة. في Rust، جميع العناصر (الدوال، الأساليب، البنى، التعدادات، الوحدات، والثوابت) خاصة للوحدات الأصل افتراضيًا. إذا كنت تريد جعل عنصر مثل دالة أو بنية خاصًا، فأنت تضعه في وحدة.

لا يمكن للعناصر في الوحدة الأصل استخدام العناصر الخاصة داخل الوحدات الفرعية، لكن يمكن للعناصر في الوحدات الفرعية استخدام العناصر في وحداتها الأجداد. هذا لأن الوحدات الفرعية تغلف وتخفي تفاصيل التنفيذ الخاصة بها، لكن الوحدات الفرعية يمكنها رؤية السياق الذي تم تعريفها فيه. لمواصلة استعارتنا، فكر في قواعد الخصوصية كأنها مثل مكتب خلفي في مطعم: ما يحدث هناك خاص بعملاء المطعم، لكن مديري المكتب يمكنهم رؤية وفعل كل شيء في المطعم الذي يديرونه.

اختار Rust أن يعمل نظام الوحدات بهذه الطريقة بحيث يكون إخفاء تفاصيل التنفيذ الداخلية هو الافتراضي. بهذه الطريقة، تعرف أي أجزاء من الكود الداخلي يمكنك تغييرها دون كسر الكود الخارجي. ومع ذلك، يمنحك Rust خيار كشف أجزاء داخلية من كود الوحدات الفرعية إلى الوحدات الأجداد الخارجية باستخدام الكلمة المفتاحية `pub` لجعل عنصر عامًا.

### كشف المسارات باستخدام الكلمة المفتاحية `pub`

لنعد إلى الخطأ في القائمة 7-4 الذي أخبرنا أن وحدة `hosting` خاصة. نريد أن تكون لدالة `eat_at_restaurant` في الوحدة الأصل إمكانية الوصول إلى دالة `add_to_waitlist` في الوحدة الفرعية، لذا نضع على وحدة `hosting` الكلمة المفتاحية `pub`، كما هو موضح في القائمة 7-5.

<Listing number="7-5" file-name="src/lib.rs" caption="التصريح عن وحدة `hosting` على أنها `pub` لاستخدامها من `eat_at_restaurant`">

```rust,ignore,does_not_compile
{{#rustdoc_include ../listings/ch07-managing-growing-projects/listing-07-05/src/lib.rs:here}}
```

</Listing>

لسوء الحظ، الكود في القائمة 7-5 لا يزال ينتج أخطاء المُترجم، كما هو موضح في القائمة 7-6.

<Listing number="7-6" caption="أخطاء المُترجم من بناء الكود في القائمة 7-5">

```console
{{#include ../listings/ch07-managing-growing-projects/listing-07-05/output.txt}}
```

</Listing>

ماذا حدث؟ إضافة الكلمة المفتاحية `pub` أمام `mod hosting` يجعل الوحدة عامة. مع هذا التغيير، إذا كان يمكننا الوصول إلى `front_of_house`، يمكننا الوصول إلى `hosting`. لكن _محتويات_ `hosting` لا تزال خاصة؛ جعل الوحدة عامة لا يجعل محتوياتها عامة. الكلمة المفتاحية `pub` على وحدة تسمح فقط للكود في وحداتها الأجداد بالإشارة إليها، وليس الوصول إلى كودها الداخلي. لأن الوحدات حاويات، لا يوجد الكثير مما يمكننا فعله بمجرد جعل الوحدة عامة؛ نحتاج إلى الذهاب أبعد من ذلك واختيار جعل عنصر واحد أو أكثر داخل الوحدة عامًا أيضًا.

الأخطاء في القائمة 7-6 تقول أن دالة `add_to_waitlist` خاصة. قواعد الخصوصية تنطبق على البنى، التعدادات، الدوال، والأساليب وكذلك الوحدات.

لنجعل أيضًا دالة `add_to_waitlist` عامة بإضافة الكلمة المفتاحية `pub` قبل تعريفها، كما في القائمة 7-7.

<Listing number="7-7" file-name="src/lib.rs" caption="إضافة الكلمة المفتاحية `pub` إلى `mod hosting` و `fn add_to_waitlist` يسمح لنا باستدعاء الدالة من `eat_at_restaurant`.">

```rust,noplayground,test_harness
{{#rustdoc_include ../listings/ch07-managing-growing-projects/listing-07-07/src/lib.rs:here}}
```

</Listing>

الآن سيُترجم الكود! لمعرفة سبب السماح لنا بإضافة الكلمة المفتاحية `pub` باستخدام هذه المسارات في `eat_at_restaurant` فيما يتعلق بقواعد الخصوصية، لننظر إلى المسارات المطلقة والنسبية.

في المسار المطلق، نبدأ بـ `crate`، جذر شجرة وحدات صندوقنا. وحدة `front_of_house` معرّفة في جذر الصندوق. بينما `front_of_house` ليست عامة، لأن دالة `eat_at_restaurant` معرّفة في نفس الوحدة التي يوجد فيها `front_of_house` (أي، `eat_at_restaurant` و `front_of_house` أشقاء)، يمكننا الإشارة إلى `front_of_house` من `eat_at_restaurant`. التالي هو وحدة `hosting` الموسومة بـ `pub`. يمكننا الوصول إلى الوحدة الأصل لـ `hosting`، لذا يمكننا الوصول إلى `hosting`. أخيرًا، دالة `add_to_waitlist` موسومة بـ `pub`، ويمكننا الوصول إلى وحدتها الأصل، لذا يعمل استدعاء الدالة هذا!

في المسار النسبي، المنطق هو نفسه المسار المطلق باستثناء الخطوة الأولى: بدلاً من البدء من جذر الصندوق، يبدأ المسار من `front_of_house`. وحدة `front_of_house` معرّفة داخل نفس الوحدة التي يوجد فيها `eat_at_restaurant`، لذا فإن المسار النسبي الذي يبدأ من الوحدة التي تم تعريف `eat_at_restaurant` فيها يعمل. ثم، لأن `hosting` و `add_to_waitlist` موسومة بـ `pub`، باقي المسار يعمل، واستدعاء الدالة هذا صالح!

إذا كنت تخطط لمشاركة صندوق مكتبتك بحيث يمكن للمشاريع الأخرى استخدام كودك، فإن واجهة برمجة التطبيقات العامة الخاصة بك هي عقدك مع مستخدمي صندوقك والذي يحدد كيف يمكنهم التفاعل مع كودك. هناك العديد من الاعتبارات حول إدارة التغييرات على واجهة برمجة التطبيقات العامة الخاصة بك لتسهيل اعتماد الأشخاص على صندوقك. هذه الاعتبارات خارج نطاق هذا الكتاب؛ إذا كنت مهتمًا بهذا الموضوع، راجع [إرشادات Rust API][api-guidelines].

> #### أفضل الممارسات للحزم التي تحتوي على ملف ثنائي ومكتبة
>
> ذكرنا أن الحزمة يمكن أن تحتوي على كل من جذر صندوق ثنائي _src/main.rs_ بالإضافة إلى جذر صندوق مكتبة _src/lib.rs_، وكلا الصندوقين سيحملان اسم الحزمة افتراضيًا. عادةً، الحزم ذات هذا النمط الذي يحتوي على كل من مكتبة وصندوق ثنائي ستحتوي على كود كافٍ فقط في الصندوق الثنائي لبدء ملف تنفيذي يستدعي الكود المعرّف في صندوق المكتبة. هذا يتيح للمشاريع الأخرى الاستفادة من معظم الوظائف التي توفرها الحزمة لأن كود صندوق المكتبة يمكن مشاركته.
>
> يجب تعريف شجرة الوحدات في _src/lib.rs_. بعد ذلك، يمكن استخدام أي عناصر عامة في الصندوق الثنائي عن طريق بدء المسارات باسم الحزمة. يصبح الصندوق الثنائي مستخدمًا لصندوق المكتبة تمامًا كما يستخدم صندوق خارجي تمامًا صندوق المكتبة: يمكنه فقط استخدام واجهة برمجة التطبيقات العامة. هذا يساعدك على تصميم واجهة برمجة تطبيقات جيدة؛ ليس فقط أنت المؤلف، بل أنت أيضًا عميل!
>
> في [الفصل 12][ch12]<!-- ignore -->، سنوضح هذه الممارسة التنظيمية ببرنامج سطر أوامر سيحتوي على كل من صندوق ثنائي وصندوق مكتبة.

### بدء المسارات النسبية باستخدام `super`

يمكننا إنشاء مسارات نسبية تبدأ في الوحدة الأصل، بدلاً من الوحدة الحالية أو جذر الصندوق، باستخدام `super` في بداية المسار. هذا مثل بدء مسار نظام ملفات بصياغة `..` التي تعني الانتقال إلى الدليل الأصل. استخدام `super` يسمح لنا بالإشارة إلى عنصر نعلم أنه في الوحدة الأصل، مما يمكن أن يجعل إعادة ترتيب شجرة الوحدات أسهل عندما تكون الوحدة مرتبطة ارتباطًا وثيقًا بالأصل ولكن قد يتم نقل الأصل إلى مكان آخر في شجرة الوحدات في يوم ما.

خذ بعين الاعتبار الكود في القائمة 7-8 الذي ينمذج الموقف الذي يصلح فيه طاهٍ طلبًا غير صحيح ويحضره شخصيًا للعميل. تستدعي دالة `fix_incorrect_order` المعرّفة في وحدة `back_of_house` دالة `deliver_order` المعرّفة في الوحدة الأصل عن طريق تحديد المسار إلى `deliver_order`، بدءًا من `super`.

<Listing number="7-8" file-name="src/lib.rs" caption="استدعاء دالة باستخدام مسار نسبي يبدأ بـ `super`">

```rust,noplayground,test_harness
{{#rustdoc_include ../listings/ch07-managing-growing-projects/listing-07-08/src/lib.rs}}
```

</Listing>

دالة `fix_incorrect_order` موجودة في وحدة `back_of_house`، لذا يمكننا استخدام `super` للانتقال إلى الوحدة الأصل لـ `back_of_house`، والتي في هذه الحالة هي `crate`، الجذر. من هناك، نبحث عن `deliver_order` ونجدها. نجاح! نعتقد أن وحدة `back_of_house` ودالة `deliver_order` من المرجح أن تبقى في نفس العلاقة مع بعضها البعض وأن يتم نقلها معًا إذا قررنا إعادة تنظيم شجرة وحدات الصندوق. لذلك، استخدمنا `super` بحيث يكون لدينا أماكن أقل لتحديث الكود في المستقبل إذا تم نقل هذا الكود إلى وحدة مختلفة.

### جعل البنى والتعدادات عامة

يمكننا أيضًا استخدام `pub` لتعيين البنى والتعدادات كعامة، لكن هناك بعض التفاصيل الإضافية لاستخدام `pub` مع البنى والتعدادات. إذا استخدمنا `pub` قبل تعريف بنية، نجعل البنية عامة، لكن حقول البنية ستظل خاصة. يمكننا جعل كل حقل عامًا أو لا حسب كل حالة على حدة. في القائمة 7-9، عرّفنا بنية `back_of_house::Breakfast` عامة مع حقل `toast` عام لكن حقل `seasonal_fruit` خاص. هذا ينمذج الحالة في مطعم حيث يمكن للعميل اختيار نوع الخبز الذي يأتي مع الوجبة، لكن الطاهي يقرر أي فاكهة ترافق الوجبة بناءً على ما هو متوفر في الموسم وفي المخزون. الفواكه المتاحة تتغير بسرعة، لذا لا يمكن للعملاء اختيار الفاكهة أو حتى رؤية أي فاكهة سيحصلون عليها.

<Listing number="7-9" file-name="src/lib.rs" caption="بنية مع بعض الحقول العامة وبعض الحقول الخاصة">

```rust,noplayground
{{#rustdoc_include ../listings/ch07-managing-growing-projects/listing-07-09/src/lib.rs}}
```

</Listing>

لأن حقل `toast` في بنية `back_of_house::Breakfast` عام، في `eat_at_restaurant` يمكننا الكتابة والقراءة إلى حقل `toast` باستخدام علامة النقطة. لاحظ أننا لا يمكننا استخدام حقل `seasonal_fruit` في `eat_at_restaurant`، لأن `seasonal_fruit` خاص. حاول إلغاء التعليق على السطر الذي يعدل قيمة حقل `seasonal_fruit` لترى أي خطأ تحصل عليه!

أيضًا، لاحظ أنه بسبب أن `back_of_house::Breakfast` لديها حقل خاص، تحتاج البنية إلى توفير دالة مرتبطة عامة تنشئ نسخة من `Breakfast` (سميناها `summer` هنا). إذا لم يكن لدى `Breakfast` مثل هذه الدالة، لم نتمكن من إنشاء نسخة من `Breakfast` في `eat_at_restaurant`، لأننا لم نتمكن من تعيين قيمة حقل `seasonal_fruit` الخاص في `eat_at_restaurant`.

على النقيض من ذلك، إذا جعلنا تعداد عامًا، فإن جميع متغيراته تصبح عامة. نحتاج فقط إلى `pub` قبل الكلمة المفتاحية `enum`، كما هو موضح في القائمة 7-10.

<Listing number="7-10" file-name="src/lib.rs" caption="تعيين تعداد كعام يجعل جميع متغيراته عامة.">

```rust,noplayground
{{#rustdoc_include ../listings/ch07-managing-growing-projects/listing-07-10/src/lib.rs}}
```

</Listing>

لأننا جعلنا تعداد `Appetizer` عامًا، يمكننا استخدام المتغيرات `Soup` و `Salad` في `eat_at_restaurant`.

التعدادات ليست مفيدة جدًا إلا إذا كانت متغيراتها عامة؛ سيكون من المزعج الاضطرار إلى شرح جميع متغيرات التعداد بـ `pub` في كل حالة، لذا فإن الافتراضي لمتغيرات التعداد هو أن تكون عامة. البنى غالبًا ما تكون مفيدة دون أن تكون حقولها عامة، لذا تتبع حقول البنى القاعدة العامة بأن كل شيء خاص افتراضيًا ما لم يُشرح بـ `pub`.

هناك موقف آخر يتعلق بـ `pub` لم نغطيه، وهذا هو آخر ميزة في نظام الوحدات لدينا: الكلمة المفتاحية `use`. سنغطي `use` بمفردها أولاً، ثم سنوضح كيفية دمج `pub` و `use`.

[pub]: ch07-03-paths-for-referring-to-an-item-in-the-module-tree.html#exposing-paths-with-the-pub-keyword
[api-guidelines]: https://rust-lang.github.io/api-guidelines/
[ch12]: ch12-00-an-io-project.html
