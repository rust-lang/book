## العمل مع متغيرات البيئة (Working with Environment Variables)

سنحسّن البرنامج الثنائي `minigrep` بإضافة ميزة إضافية: خيار للبحث غير الحساس
لحالة الأحرف يمكن للمستخدم تشغيله عبر متغير بيئي (environment variable). يمكننا جعل هذه الميزة خيارًا
في سطر الأوامر (command line) ونطلب من المستخدمين إدخاله في كل مرة يريدون تطبيقه، ولكن بجعله
بدلاً من ذلك متغير بيئي (environment variable)، نسمح لمستخدمينا بتعيين متغير البيئة (environment variable) مرة واحدة ويكون كل
بحثهم غير حساس لحالة الأحرف في جلسة الطرفية تلك.

<!-- Old headings. Do not remove or links may break. -->

<a id="writing-a-failing-test-for-the-case-insensitive-search-function"></a>

### كتابة اختبار فاشل للبحث غير الحساس لحالة الأحرف

أولاً نضيف دالة جديدة `search_case_insensitive` إلى مكتبة `minigrep` والتي سيتم
استدعاؤها عندما يكون لمتغير البيئة قيمة. سنواصل اتباع عملية TDD، لذا فإن الخطوة
الأولى مرة أخرى هي كتابة اختبار فاشل. سنضيف اختبارًا جديدًا لدالة
`search_case_insensitive` الجديدة ونعيد تسمية اختبارنا القديم من `one_result`
إلى `case_sensitive` لتوضيح الاختلافات بين الاختبارين، كما هو موضح في القائمة
12-20.

<Listing number="12-20" file-name="src/lib.rs" caption="إضافة اختبار فاشل جديد للدالة غير الحساسة لحالة الأحرف التي نحن على وشك إضافتها">

```rust,ignore,does_not_compile
{{#rustdoc_include ../listings/ch12-an-io-project/listing-12-20/src/lib.rs:here}}
```

</Listing>

لاحظ أننا عدّلنا `contents` للاختبار القديم أيضًا. لقد أضفنا سطرًا جديدًا بالنص
`"Duct tape."` باستخدام حرف كبير _D_ الذي لا يجب أن يطابق الاستعلام `"duct"`
عندما نبحث بطريقة حساسة لحالة الأحرف. تغيير الاختبار القديم بهذه الطريقة يساعد
على ضمان عدم كسرنا عن طريق الخطأ لوظيفة البحث الحساسة لحالة الأحرف التي نفذناها
بالفعل. يجب أن ينجح هذا الاختبار الآن ويجب أن يستمر في النجاح أثناء عملنا على
البحث غير الحساس لحالة الأحرف.

الاختبار الجديد للبحث _غير الحساس_ لحالة الأحرف يستخدم `"rUsT"` كاستعلامه. في
دالة `search_case_insensitive` التي نحن على وشك إضافتها، يجب أن يطابق الاستعلام
`"rUsT"` السطر الذي يحتوي على `"Rust:"` بحرف كبير _R_ ويطابق السطر `"Trust
me."` حتى لو كان كلاهما لهما حالة أحرف مختلفة عن الاستعلام. هذا هو اختبارنا
الفاشل، وسيفشل في التصريف لأننا لم نعرّف دالة `search_case_insensitive` بعد.
لا تتردد في إضافة تطبيق هيكلي يعيد دائمًا متجهًا فارغًا، بشكل مشابه للطريقة التي
فعلناها بها لدالة `search` في القائمة 12-16 لرؤية الاختبار يُصرّف ويفشل.

### تطبيق دالة `search_case_insensitive`

ستكون دالة `search_case_insensitive`، الموضحة في القائمة 12-21، مماثلة تقريبًا
لدالة `search`. الاختلاف الوحيد هو أننا سنحوّل `query` وكل `line` إلى أحرف
صغيرة بحيث مهما كانت حالة معاملات الإدخال، ستكون بنفس الحالة عندما نتحقق مما إذا
كان السطر يحتوي على الاستعلام.

<Listing number="12-21" file-name="src/lib.rs" caption="تعريف دالة `search_case_insensitive` لتحويل الاستعلام والسطر إلى أحرف صغيرة قبل مقارنتهما">

```rust,noplayground
{{#rustdoc_include ../listings/ch12-an-io-project/listing-12-21/src/lib.rs:here}}
```

</Listing>

أولاً، نحوّل نص `query` إلى أحرف صغيرة ونخزنه في متغير جديد بنفس الاسم، مما يحجب
`query` الأصلي. استدعاء `to_lowercase` على الاستعلام ضروري بحيث بغض النظر عما
إذا كان استعلام المستخدم `"rust"` أو `"RUST"` أو `"Rust"` أو `"rUsT"`، سنتعامل
مع الاستعلام كما لو كان `"rust"` ونكون غير حساسين لحالة الأحرف. بينما سيتعامل
`to_lowercase` مع Unicode الأساسي، لن يكون دقيقًا بنسبة 100 بالمائة. إذا كنا
نكتب تطبيقًا حقيقيًا، سنرغب في القيام بمزيد من العمل هنا، لكن هذا القسم يتعلق
بمتغيرات البيئة، وليس Unicode، لذا سنتركه عند هذا الحد هنا.

لاحظ أن `query` الآن هو `String` بدلاً من شريحة نصية لأن استدعاء `to_lowercase`
ينشئ بيانات جديدة بدلاً من الإشارة إلى بيانات موجودة. لنقل أن الاستعلام هو
`"rUsT"`، كمثال: تلك الشريحة النصية لا تحتوي على `u` أو `t` صغيرة لنستخدمها،
لذا علينا تخصيص `String` جديد يحتوي على `"rust"`. عندما نمرر `query` كمعامل
إلى تابع `contains` الآن، نحتاج إلى إضافة علامة & لأن توقيع `contains` معرّف
لأخذ شريحة نصية.

بعد ذلك، نضيف استدعاءً لـ `to_lowercase` على كل `line` لتحويل جميع الأحرف إلى
أحرف صغيرة. الآن بعد أن حوّلنا `line` و `query` إلى أحرف صغيرة، سنجد التطابقات
بغض النظر عن حالة أحرف الاستعلام.

لنرى ما إذا كان هذا التطبيق ينجح في الاختبارات:

```console
{{#include ../listings/ch12-an-io-project/listing-12-21/output.txt}}
```

عظيم! لقد نجحوا. الآن لنستدع دالة `search_case_insensitive` الجديدة من دالة
`run`. أولاً، سنضيف خيار تكوين إلى بنية `Config` للتبديل بين البحث الحساس
لحالة الأحرف والبحث غير الحساس لحالة الأحرف. إضافة هذا الحقل ستسبب أخطاء
المصرِّف لأننا لا نقوم بتهيئة هذا الحقل في أي مكان بعد:

<span class="filename">اسم الملف: src/main.rs</span>

```rust,ignore,does_not_compile
{{#rustdoc_include ../listings/ch12-an-io-project/listing-12-22/src/main.rs:here}}
```

أضفنا حقل `ignore_case` الذي يحتفظ بقيمة منطقية (Boolean). بعد ذلك، نحتاج دالة
`run` للتحقق من قيمة حقل `ignore_case` واستخدام ذلك لتحديد ما إذا كان يجب
استدعاء دالة `search` أو دالة `search_case_insensitive`، كما هو موضح في القائمة
12-22. لاحظ أن هذا لن يُصرّف بعد.

<Listing number="12-22" file-name="src/main.rs" caption="استدعاء إما `search` أو `search_case_insensitive` بناءً على القيمة في `config.ignore_case`">

```rust,ignore,does_not_compile
{{#rustdoc_include ../listings/ch12-an-io-project/listing-12-22/src/main.rs:there}}
```

</Listing>

أخيرًا، نحتاج إلى التحقق من متغير البيئة. الدوال للعمل مع متغيرات البيئة موجودة
في وحدة `env` في المكتبة القياسية، والتي هي بالفعل في النطاق في أعلى
_src/main.rs_. سنستخدم دالة `var` من وحدة `env` للتحقق مما إذا كانت أي قيمة قد
تم تعيينها لمتغير بيئي يُسمى `IGNORE_CASE`، كما هو موضح في القائمة 12-23.

<Listing number="12-23" file-name="src/main.rs" caption="التحقق من أي قيمة في متغير بيئي يُسمى `IGNORE_CASE`">

```rust,ignore,noplayground
{{#rustdoc_include ../listings/ch12-an-io-project/listing-12-23/src/main.rs:here}}
```

</Listing>

هنا، ننشئ متغيرًا جديدًا، `ignore_case`. لتعيين قيمته، نستدعي دالة `env::var`
ونمررها اسم متغير البيئة (environment variable) `IGNORE_CASE`. تُرجع دالة `env::var` `Result` التي
ستكون متغير `Ok` الناجح الذي يحتوي على قيمة متغير البيئة (environment variable) إذا تم تعيين متغير
البيئة (environment variable) لأي قيمة. ستُرجع متغير `Err` إذا لم يتم تعيين متغير البيئة (environment variable).

نستخدم تابع `is_ok` على `Result` للتحقق مما إذا كان متغير البيئة (environment variable) مُعيّنًا، مما
يعني أنه يجب على البرنامج إجراء بحث غير حساس لحالة الأحرف. إذا لم يتم تعيين
متغير البيئة (environment variable) `IGNORE_CASE` لأي شيء، فسيُرجع `is_ok` القيمة `false` وسيجري
البرنامج بحثًا حساسًا لحالة الأحرف. نحن لا نهتم بـ _قيمة_ متغير البيئة (environment variable)، فقط ما
إذا كان مُعيّنًا أو غير مُعيّن، لذا نتحقق من `is_ok` بدلاً من استخدام `unwrap`
أو `expect` أو أي من التوابع الأخرى التي رأيناها على `Result`.

نمرر القيمة في متغير `ignore_case` إلى مثيل `Config` بحيث يمكن لدالة `run` قراءة
تلك القيمة وتحديد ما إذا كان يجب استدعاء `search_case_insensitive` أو `search`،
كما نفذناه في القائمة 12-22.

لنجربه! أولاً، سنشغل برنامجنا بدون تعيين متغير البيئة وبالاستعلام `to`، الذي
يجب أن يطابق أي سطر يحتوي على الكلمة _to_ بأحرف صغيرة:

```console
{{#include ../listings/ch12-an-io-project/listing-12-23/output.txt}}
```

يبدو أن هذا لا يزال يعمل! الآن لنشغل البرنامج مع تعيين `IGNORE_CASE` إلى `1`
ولكن بنفس الاستعلام `to`:

```console
$ IGNORE_CASE=1 cargo run -- to poem.txt
```

إذا كنت تستخدم PowerShell، ستحتاج إلى تعيين متغير البيئة وتشغيل البرنامج كأوامر
منفصلة:

```console
PS> $Env:IGNORE_CASE=1; cargo run -- to poem.txt
```

سيجعل هذا `IGNORE_CASE` يستمر لبقية جلسة shell الخاصة بك. يمكن إلغاء تعيينه
باستخدام cmdlet `Remove-Item`:

```console
PS> Remove-Item Env:IGNORE_CASE
```

يجب أن نحصل على أسطر تحتوي على _to_ قد تحتوي على أحرف كبيرة:

<!-- manual-regeneration
cd listings/ch12-an-io-project/listing-12-23
IGNORE_CASE=1 cargo run -- to poem.txt
can't extract because of the environment variable
-->

```console
Are you nobody, too?
How dreary to be somebody!
To tell your name the livelong day
To an admiring bog!
```

ممتاز، حصلنا أيضًا على أسطر تحتوي على _To_! يمكن الآن لبرنامج `minigrep` الخاص
بنا إجراء بحث غير حساس لحالة الأحرف يتم التحكم فيه بواسطة متغير بيئي. الآن
تعرف كيفية إدارة الخيارات المُعيّنة باستخدام إما معاملات سطر الأوامر أو متغيرات
البيئة.

تسمح بعض البرامج بالمعاملات (arguments) _ومتغيرات البيئة_ (environment variables) لنفس التكوين. في تلك الحالات،
تقرر البرامج أن أحدهما أو الآخر له الأولوية. لممارسة أخرى بنفسك، حاول التحكم في
الحساسية لحالة الأحرف إما من خلال معامل سطر أوامر (command line argument) أو متغير بيئي (environment variable). حدد ما إذا كان
يجب أن يكون لمعامل سطر الأوامر (command line argument) أو متغير البيئة (environment variable) الأولوية إذا تم تشغيل البرنامج
مع تعيين أحدهما للحساسية لحالة الأحرف والآخر لتجاهل الحالة.

تحتوي وحدة `std::env` على العديد من الميزات المفيدة الأخرى للتعامل مع متغيرات
البيئة (environment variables): راجع وثائقها لمعرفة ما هو متاح.
